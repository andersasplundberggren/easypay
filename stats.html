<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIK Karlskoga - F√∂rs√§ljningsstatistik</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary: #1e3c72;
            --primary-dark: #152a4f;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            border-bottom: 3px solid var(--primary);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .header .logo {
            width: 40px;
            height: 40px;
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .header-actions a {
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
            background: var(--primary);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: 0.2s;
        }
        
        .header-actions a:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem 2rem;
        }
        
        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .control-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--dark);
            white-space: nowrap;
        }
        
        .controls input, .controls select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            transition: all 0.2s;
        }
        
        .controls input:focus, .controls select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .export-buttons {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card h3 {
            color: #6b7280;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            color: var(--dark);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            line-height: 1;
        }
        
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }
        
        .chart-container h2 {
            color: var(--dark);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .stock-table {
            width: 100%;
            font-size: 0.875rem;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .stock-table th {
            background: var(--light);
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
        }
        
        .stock-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .stock-table tr:hover {
            background: rgba(30, 60, 114, 0.03);
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .ok {
            background: #d4edda;
            color: #155724;
        }
        
        .low {
            background: #fff3cd;
            color: #856404;
        }
        
        .crit {
            background: #f8d7da;
            color: #721c24;
        }
        
        .out {
            background: #d6d6d6;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .loading::before {
            content: '';
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--danger);
            margin: 1rem 0;
            font-size: 0.875rem;
        }
        
        .info-banner {
            background: #dbeafe;
            color: #1e40af;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>
                <img src="https://sportality.cdn.s8y.se/team-logos/bik1_bik.svg" alt="BIK" class="logo">
                BIK Karlskoga F√∂rs√§ljningsstatistik
            </h1>
            <div class="header-actions">
                <a href="lager.html">Lagerhantering ‚Üí</a>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label>Period:</label>
                <select id="periodSelect">
                    <option value="today">Idag</option>
                    <option value="yesterday">Ig√•r</option>
                    <option value="week" selected>Denna vecka</option>
                    <option value="month">Denna m√•nad</option>
                    <option value="custom">Anpassad</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Fr√•n:</label>
                <input type="date" id="startDate">
            </div>
            
            <div class="control-group">
                <label>Till:</label>
                <input type="date" id="endDate">
            </div>
            
            <button class="btn btn-primary" onclick="loadStatistics()">Uppdatera</button>
            
            <div class="export-buttons">
                <button class="btn btn-success" onclick="exportToExcel()">Excel</button>
                <button class="btn btn-success" onclick="window.print()">Skriv ut</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total f√∂rs√§ljning</h3>
                <div class="value" id="totalSales">0 kr</div>
            </div>
            
            <div class="stat-card">
                <h3>Antal transaktioner</h3>
                <div class="value" id="totalTransactions">0</div>
            </div>
            
            <div class="stat-card">
                <h3>Snittk√∂p</h3>
                <div class="value" id="avgTransaction">0 kr</div>
            </div>
            
            <div class="stat-card">
                <h3>Mest s√•lda produkt</h3>
                <div class="value" id="topProduct" style="font-size: 1.25rem;">-</div>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>F√∂rs√§ljning √∂ver tid</h2>
            <div class="chart-wrapper">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-container">
                <h2>
                    Lagerstatus
                    <button class="btn btn-primary" onclick="loadStockStatus()">üîÑ Uppdatera</button>
                </h2>
                
                <div class="info-banner">
                    ‚ÑπÔ∏è Visar aktuellt lagersaldo. F√∂r att registrera p√•fyllningar och justeringar, g√• till <a href="lager.html" style="color: inherit; font-weight: 600;">Lagerhantering</a>.
                </div>
                
                <div class="chart-wrapper" style="height: auto; max-height: 500px; overflow-y: auto;">
                    <div id="stockStatus">
                        <div class="loading">Laddar lagerstatus...</div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <h2>Topp 10 produkter</h2>
                <div class="chart-wrapper" style="height: 300px;">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWADYHeT2clN3DSHnIvp-d24APaKiacETGSWK4EecuzjoKru1RbB7a3MsxuqIBrPw/exec';
        
        let allPurchases = [];
        let salesChart = null;
        let topProductsChart = null;
        
        function setDateRange(period) {
            const today = new Date();
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            switch(period) {
                case 'today':
                    startDate.value = today.toISOString().split('T')[0];
                    endDate.value = today.toISOString().split('T')[0];
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate.value = yesterday.toISOString().split('T')[0];
                    endDate.value = yesterday.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay() + 1);
                    startDate.value = weekStart.toISOString().split('T')[0];
                    endDate.value = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate.value = monthStart.toISOString().split('T')[0];
                    endDate.value = today.toISOString().split('T')[0];
                    break;
            }
        }
        
        async function loadStatistics() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    alert('V√§lj b√•de start- och slutdatum');
                    return;
                }
                
                const url = `${GOOGLE_APPS_SCRIPT_URL}?action=getPurchases&startDate=${startDate}&endDate=${endDate}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.error) throw new Error(result.error);
                
                allPurchases = result.data || [];
                updateOverviewCards();
                updateSalesChart();
                updateProductCharts();
                
            } catch (error) {
                console.error('Fel vid laddning av statistik:', error);
                alert('Kunde inte ladda statistik: ' + error.message);
            }
        }
        
        function updateOverviewCards() {
            const totalSales = allPurchases.reduce((sum, p) => sum + parseFloat(p.total_amount || 0), 0);
            const totalTransactions = allPurchases.length;
            const avgTransaction = totalTransactions > 0 ? totalSales / totalTransactions : 0;
            
            const productCounts = {};
            allPurchases.forEach(purchase => {
                if (purchase.items && Array.isArray(purchase.items)) {
                    purchase.items.forEach(item => {
                        productCounts[item.name] = (productCounts[item.name] || 0) + (item.quantity || 1);
                    });
                }
            });
            
            const topProduct = Object.entries(productCounts).sort((a, b) => b[1] - a[1])[0];
            
            document.getElementById('totalSales').textContent = `${totalSales.toFixed(0)} kr`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('avgTransaction').textContent = `${avgTransaction.toFixed(0)} kr`;
            
            if (topProduct) {
                document.getElementById('topProduct').textContent = topProduct[0];
            }
        }
        
        function updateSalesChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            const salesByDay = {};
            allPurchases.forEach(purchase => {
                const date = new Date(purchase.created_at).toISOString().split('T')[0];
                salesByDay[date] = (salesByDay[date] || 0) + parseFloat(purchase.total_amount || 0);
            });
            
            const sortedDates = Object.keys(salesByDay).sort();
            const formattedLabels = sortedDates.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('sv-SE', { month: 'short', day: 'numeric' });
            });
            
            if (salesChart) salesChart.destroy();
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: 'F√∂rs√§ljning (kr)',
                        data: sortedDates.map(date => salesByDay[date]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function updateProductCharts() {
            const productSales = {};
            allPurchases.forEach(purchase => {
                if (purchase.items && Array.isArray(purchase.items)) {
                    purchase.items.forEach(item => {
                        if (!productSales[item.name]) {
                            productSales[item.name] = { quantity: 0, revenue: 0 };
                        }
                        productSales[item.name].quantity += (item.quantity || 1);
                        productSales[item.name].revenue += parseFloat(item.price || 0) * (item.quantity || 1);
                    });
                }
            });
            
            const sortedProducts = Object.entries(productSales).sort((a, b) => b[1].revenue - a[1].revenue);
            const barCtx = document.getElementById('topProductsChart').getContext('2d');
            
            if (topProductsChart) topProductsChart.destroy();
            
            const top10 = sortedProducts.slice(0, 10);
            
            topProductsChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: top10.map(([name]) => name),
                    datasets: [{
                        label: 'Antal s√•lda',
                        data: top10.map(([_, data]) => data.quantity),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // ===== LAGERSTATUS (READ-ONLY) =====
        async function loadStockStatus() {
            try {
                document.getElementById('stockStatus').innerHTML = '<div class="loading">H√§mtar lagerstatus...</div>';
                
                // H√§mta produkter
                const productsResponse = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getProducts`);
                const productsResult = await productsResponse.json();
                if (productsResult.error) throw new Error(productsResult.error);
                const products = productsResult.data || [];
                
                // H√§mta lagersammanfattning
                const stockResponse = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getStockSummary`);
                const stockResult = await stockResponse.json();
                const stockSummary = stockResult.data || [];
                
                // Skapa en map med product_id som nyckel
                const stockById = {};
                stockSummary.forEach(s => {
                    stockById[String(s.product_id)] = s;
                });
                
                // Bygg tabell
                let tableHTML = `
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>I lager</th>
                                <th>Best√§llningspunkt</th>
                                <th>Senast p√•fyllt</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                products.forEach(product => {
                    const pid = String(product.id);
                    const stock = stockById[pid] || {};
                    const onHand = Number(stock.on_hand || 0);
                    const reorderPoint = stock.reorder_point != null ? Number(stock.reorder_point) : 
                                        (product.reorder_point ? Number(product.reorder_point) : null);
                    const lastRestock = stock.last_restock_at ? new Date(stock.last_restock_at).toLocaleString('sv-SE') : '-';
                    
                    // Best√§m status
                    let statusClass = 'ok';
                    let statusText = 'OK';
                    
                    if (onHand <= 0) {
                        statusClass = 'out';
                        statusText = 'SLUT';
                    } else if (reorderPoint != null) {
                        if (onHand <= reorderPoint * 0.1) {
                            statusClass = 'crit';
                            statusText = 'KRITISKT';
                        } else if (onHand <= reorderPoint * 0.4) {
                            statusClass = 'low';
                            statusText = 'L√ÖGT';
                        }
                    }
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${product.name}</strong> <span style="opacity:.6;font-size:.8em">(#${pid})</span></td>
                            <td><strong>${onHand}</strong></td>
                            <td>${reorderPoint != null ? reorderPoint : '-'}</td>
                            <td>${lastRestock}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                document.getElementById('stockStatus').innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Fel vid laddning av lagerstatus:', error);
                document.getElementById('stockStatus').innerHTML = 
                    `<div class="error">Kunde inte ladda lagerstatus: ${error.message}</div>`;
            }
        }
        
        function exportToExcel() {
            if (allPurchases.length === 0) {
                alert('Ingen data att exportera');
                return;
            }
            
            const excelData = allPurchases.map(purchase => {
                const products = purchase.items ? 
                    purchase.items.map(item => `${item.name} (${item.quantity || 1})`).join(', ') : '';
                
                return {
                    'Datum': new Date(purchase.created_at).toLocaleString('sv-SE'),
                    'Kvitto-ID': purchase.id,
                    'Produkter': products,
                    'Belopp ex. moms': purchase.amount || 0,
                    'Moms': purchase.vat_amount || 0,
                    'Totalt': purchase.total_amount || 0,
                    'Kassa': purchase.cashier_name || ''
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'F√∂rs√§ljning');
            
            const fileName = `BIK_Forsaljning_${document.getElementById('startDate').value}_${document.getElementById('endDate').value}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setDateRange('week');
            
            document.getElementById('periodSelect').addEventListener('change', function(e) {
                if (e.target.value !== 'custom') {
                    setDateRange(e.target.value);
                    loadStatistics();
                }
            });
            
            loadStatistics();
            loadStockStatus();
        });
    </script>
</body>
</html>
